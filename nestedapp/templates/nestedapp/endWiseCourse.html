{% extends 'nestedapp/base.html' %}

{% block content_wrapper %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/6.6.8/sweetalert2.min.js" integrity="sha512-ySDkgzoUz5V9hQAlAg0uMRJXZPfZjE8QiW0fFMW7Jm15pBfNn3kbGsOis5lPxswtpxyY3wF5hFKHi+R/XitalA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<style>
  .swal2-confirm {
   
    }
    .swal2-cancel{
      margin-right: 20px !important;
    }
</style>
    {% for d in data%}
        <div class="content-wrapper">
            {% block content_header %}
                <section class="content-header">
                   
                    {% block no_heading %}
                        <h1>
                           
                           <span class="semesterNameOne text-capitalize">End Day Wise Data Of {{d.category}}</span>
                        
                            
                            {% block page_name %}{% endblock %}
                            <div class="header-actions">
                                {% block page_actions %}

                                 {% endblock %}
                            </div>
                            {% block no_description %}
                            <small>{% block page_description %}{% endblock %}</small>
                            {% endblock %}
                        </h1>
                        {% block breadcrumbs %}
                        <ol class='breadcrumb'>
                            <li >
                                <a href="{%url 'dash'%}">
                                    <i class='fa fa-dashboard'></i>
                                    DashBoard
                                </a>
                            </li>
                            <li>
                               Course for {{d.category}}
                            </li>


                        </ol>
                            {# Breadcrumb implementation left to developers #}
                        {% endblock %}
                    {% endblock no_heading %}
                </section>
            {% endblock %}

            {% block content_outer %}
            <section class="content">
                {% block messages %}
                    {% include 'nestedapp/lib/_messages.html' %}
                {% endblock %}

                {% block content_block_wrap %}
                    {% block content %}
                  
                    
                      
                      <div class='row'>

                        <div class='col-md-12'>
                            <div class='box'>
                                 <div class='box-header'>
                                    <div class='row'>
                                        <div class='col-md-6'>
                                            <h3 class='box-title'>
                                                Course List of
                                               <span class="semesterNameTwo text-capitalize"></span>
                                                 {{d.category}}
                                            </h3>

                                        
                                        </div>
                                        <div class='col-md-6 text-right'>
                                            <a href="/controlling/semester/" 
                                            title="Create a new Session"
                                            class="btn btn-danger btn-sm">
                                            <i class="fa fa-angle-double-left"></i> Back
                                          </a>
                                            <button class='btn btn-primary btn-sm m_button' id="AddCourse_btn">
                                                Add Course
                                               
                                            </button>
                                        
                                        </div>

                                    </div>


                                  <!-- Modal  -->

                                  <div class="modal-dialog">
                                    <div id="myModal" class="modal">
                                      <style>
                                                            /* The Modal (background) */
                                        .modal {
                                          display: none; /* Hidden by default */
                                          position: fixed; /* Stay in place */
                                          z-index: 1; /* Sit on top */
                                          padding-top: 100px; /* Location of the box */
                                          left: 0px;
                                          top: 0;
                                          width: 100%; /* Full width */
                                          height: 100%; /* Full height */
                                          overflow: auto; /* Enable scroll if needed */
                                          background-color: rgb(0, 0, 0); /* Fallback color */
                                          background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
                                        }
                                        
                                        /* Modal Content */
                                        .modal-content {
                                          position: relative;
                                          background-color: #fefefe;
                                          margin: auto;
                                          padding: 0;
                                          border: 1px solid #888;
                                          width: 50%;
                                          box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
                                          -webkit-animation-name: animatetop;
                                          -webkit-animation-duration: 0.4s;
                                          animation-name: animatetop;
                                          animation-duration: 0.4s;
                                        }
                                        
                                        /* Add Animation */
                                        @-webkit-keyframes animatetop {
                                          from {
                                            top: -300px;
                                            opacity: 0;
                                          }
                                          to {
                                            top: 0;
                                            opacity: 1;
                                          }
                                        }
                                        
                                        @keyframes animatetop {
                                          from {
                                            top: -300px;
                                            opacity: 0;
                                          }
                                          to {
                                            top: 0;
                                            opacity: 1;
                                          }
                                        }
                                        
                                        /* The Close Button */
                                        .close {
                                          color: black;
                                          float: right;
                                          font-size: 25px;
                                          top: 10%;
                                        }
                                        
                                        .modal-header {
                                          padding: 10px;
                                        
                                          color: white;
                                        }
                                        
                                        .modal-body {
                                          padding: 2px 16px;
                                        }
                                        
                                        .modal-footer {
                                          padding: 2px 16px;
                                        
                                          color: white;
                                        }
                                        .title {
                                          font-size: 28px;
                                          color: black;
                                        }
                                        #chap_close {
                                          color: black;
                                          background: #cfcfcf;
                                        }
                                        label.required:after {
                                          content: ' *';
                                          color: red;
                                        }
                                        /*tom select css */
                                        #sessionWiseCategory .ts-wrapper.single .ts-control:after {
                                          border-color: #343a40 transparent transparent;
                                          border-style: solid;
                                          border-width: 5px 5px 0;
                                          content: none !important;
                                          display: block;
                                          height: 0;
                                          margin-top: -3px;
                                          position: absolute;
                                          right: calc(0.75rem + 5px);
                                          top: 50%;
                                          width: 0;
                                        }
                                      </style>
                
                                      <!-- Modal content -->
                                      <div class="modal-content">
                                        <style>
                                          .ts-wrapper.single .ts-control:after {
                                            border-color: #343a40 transparent transparent;
                                            border-style: solid;
                                            border-width: 5px 5px 0;
                                            content: none !important;
                                            display: block;
                                            height: 0;
                                            margin-top: -3px;
                                            position: absolute;
                                            right: calc(0.75rem + 5px);
                                            top: 50%;
                                            width: 0;
                                          }
                                          .focus .ts-control {
                                            border-color: #80bdff;
                                            box-shadow: none !important;
                                            outline: 0;
                                          }
                                        </style>
                                        <div class="modal-header">
                                          <button type="button" class="close"><span aria-hidden="true">&times;</span></button>
                                          <h5 class="title" id="exampleModalLongTitle">Create New Chatpter</h5>
                                        </div>
                                        <div class="modal-body">
                                          {% csrf_token %}
                                          <div class="form-group">
                                            <label for="name" class="required">Category</label>
                                            <input id="selectedCategory" class="form-control" readonly value="{{d.category}}">
                                          </div>
                                          <div class="form-group">
                                            <label for="name" class="required">Department</label>
                                            <span class="categoryWiseDepartment"></span>
                                          </div>
                                          <div class="form-group">
                                            <label for="name" class="required">Course</label>
                                            <span class="cat-and-dep-wiseCourse"></span>
                                          </div>
                                          <!-- append conditional select -->
                                         
                                        </div>
                                        <div class="modal-footer">
                                          <button type="button" class="btn btn-default pull-left" id="Close" data-dismiss="modal">Close</button>
                                          <button type="button" class="btn btn-primary courseSubmitButton" data-dismiss="modal">Submit</button>
                                        </div>
                                      </div>
                                    </div>
                                  </div>


                                 </div>
                                 <div class='box-body'>

                                    <table class='table table-bordered table-striped table-responsive' id="endTable">

                                        <thead>
                                            <tr>
                                                <th>Course Name</th>
                                                <th> Department</th>
                                                <th>Action</th>
                                                
                                            </tr>
                                        </thead>

                                        <tbody>
                                        
                                           
                                           
                                            
                                        </tbody>
                                    </table>
                                </div>
                                

                            </div>
                          
                            
                            
                        </div>

                      
                            
                      

                      </div>
                    {% endblock %}

                {% endblock %}
            </section>
            
            
            {% endblock   %}

              
            <script>
              // Get the modal
              var modal = document.getElementById("myModal");
              
              // Get the button that opens the modal
              
              var btn = document.getElementById("AddCourse_btn");
              var btn2 = document.getElementById("Close");
              // Get the <span> element that closes the modal
              var span = document.getElementsByClassName("close")[0];
              var edit=document.getElementsByClassName('edit')
             
               edit.onclick=function(){
                modal.style.display="block"
               }
              // When the user clicks the button, open the modal 
              btn.onclick = function() {
                modal.style.display = "block";
              }
              
              // When the user clicks on <span> (x), close the modal
              span.onclick = function() {
                modal.style.display = "none";
              }
              btn2.onclick=function(){
                modal.style.display="none";
              }
              
              // When the user clicks anywhere outside of the modal, close it
              window.onclick = function(event) {
                if (event.target == modal) {
                  modal.style.display = "none";
                }
              }
            </script>
            <script>
                var selectedDepartment=""
                var selectedCourse=""
                var category=""
                 global = " "
                var dep=[]
                var course=[]
                var endCourseTable=""
              
                $(document).ready(function(){
          
                  handleDepartment()
                  EndCourseDatatable()
                  submitCourse()
                 
                })
                function handleDepartment(){
                category=$("#selectedCategory").val()
                   var html='<input class="form-control" id="endDepartment" placeholder="select department">'
                   var select='<select class="form-control" id="idSelect" placeholder="select department"></select>'
                   $('.categoryWiseDepartment').append(select)
                selectedDepartment= new TomSelect("#idSelect",{
                    create:false,
                    sortedField:{
                        field:"text",
                        direction:'asc'
                    },
                    minItems:1,
                    maxItems:1
                   }) 

                   axios.get("{% url 'load-department'%}").then(function(response){
                    data=response.data
                    for (var i=0; i< data.length;i++){
                       if (data[i].category==category){
                           dep.push(data[i])
                         
                       }
                    }
                    dep.forEach(function(item){
                        var dep_data={value:item.id,text:item.name}
                        selectedDepartment.addOption(dep_data) 
                      
                       
                    })
                   })  
                  handleCourse()
                    
                }

                function handleCourse(){
                 course_html='<select class="form-control" id="idCourse" placeholder="Select Course"></select>'
                 $(".cat-and-dep-wiseCourse").html(course_html)
                 selectedCourse=new TomSelect("#idCourse",{
                  create:false,
                  sortedField:{
                    field:'text',
                    direction:'asc'
                  },
                  minItems:1,
                  maxItems:1
                 })
                
                 axios.get("{% url 'load-course'%}").then(function(response){
                  data=response.data
                  
                  $("#idSelect").on("change",function(){
                    global = $(this).val() 
                    var filteredCourse=data.filter((item)=> item.category_name==category && item.department_id==global)
                     console.log(filteredCourse)
                      selectedCourse.clear()
                      selectedCourse.clearOptions()
                      if(filteredCourse.length>0){
                        filteredCourse.forEach(function(item){
    
                          var c={
                            value:item.id,
                            text:item.name
                          }
                          selectedCourse.addOption(c)
                          
      
                         })
    
                      }    
                
                     })
                }) 
                }
               function submitCourse(){
                $(".courseSubmitButton").on("click",function(){
                  window.location.reload()
                  var selectedDep=$("#idSelect").val()
                  var course_value=$("#idCourse").val()
                  var csrf=$("input[name=csrfmiddlewaretoken]").val()
                 
                  if (selectedDep==""|| course_value ==""){
                  if (selectedDep==""){
                    toastr.error("department is required")
                  }
                  else if(course_value==""){
                    toastr.error("course is required")
                  }
                  }   else{
                    modal.style.display="none";

                    var data={
                      "id":"{{d.id}}",
                      "category":category,
                      "department_id":selectedDep,
                      "course_id":course_value
                                      }


                     axios.post("{% url 'save-end-course'%}",data,{
                      headers:{
                        "X-CSRFToken":csrf
                      }
                     }).then(function(response){

                     
                       
                      selectedDepartment.clear()
                      selectedCourse.clear()
                      
                      var data=response.data
                      toastr.success(data.massage)
                      
                      

                                      })

                  }               
               
                 
                
                 
                
                })
               


               }
               function EndCourseDatatable(){
               endCourseTable = $("#endTable").DataTable({
                 responsive:true,
                 autowidth:false,
                 order:[[0,"asc"]],
                 ordering:true,
                 columndefs:[{orderable:false,targets:0}]

                });
                $.ajax({
                  url:"{% url 'check-data'%}",
                  data:{
                    id:{{d.id}},
                    category:"{{d.category}}"
                  },
                  success:function(data){
                    console.log(data)
                    var list=[]
                    for (var i=0;i<data.length;i++){
                      list.push(data[i].id)
                      var btn=getDeleteButton(data[i].id)
                      endCourseTable.row.add([data[i].name,data[i].department,btn]).draw(false)
                    }
                    click(list)
                   
                  }
                })
             
               }

               function getDeleteButton(id){
               
                let btn=`<span class="btn btn-sm btn-danger" id="remove-${id}" ><i class="glyphicon glyphicon-trash"></i></span>`
                
                return btn
                
               }
             
             function click(n){
              n.forEach(function(item){
                $("#remove-"+item+"").on("click",function(){
              
                const swalWithBootstrapButtons = Swal.mixin({
                    customClass: {
                      confirmButton: 'btn btn-success',
                      cancelButton: 'btn btn-danger'
                    },
                    buttonsStyling: false
                  })
                  
                  swalWithBootstrapButtons.fire({
                    title: 'Are you sure?',
                    text: "you want to remove this course",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Remove',
                    cancelButtonText:  'Cancel',
                    reverseButtons: true
                  }).then((result) => {
                    if (result.isConfirmed) {
                     
                      $.ajax({
                        url:"{% url 'remove-endcourse'%}",
                        data:{
                          id:{{d.id}},
                          category:"{{d.category}}",
                          course_id:item
                        },
                        success:function(data){
                          
                        location.reload()
                        swalWithBootstrapButtons.fire(
                        'Removed!',
                        data.message,
                        'success'
                      )
                    
                         
                        }
                      })

                   
                    } else if (
                      /* Read more about handling dismissals below */
                      result.dismiss === Swal.DismissReason.cancel
                    ) {
                      swalWithBootstrapButtons.fire(
                        'Cancelled',
                        'Your course is safe :)',
                        'error'
                      )
                    }
                  }) 
                })
              })
             }
             
            </script>
            
            


        </div>
        {% endfor%}
        {% endblock content_wrapper %}